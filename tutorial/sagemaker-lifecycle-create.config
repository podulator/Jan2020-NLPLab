#!/bin/bash

set -e

sudo -u ec2-user -i <<'EOF'

# Install mxnet and d2l
pip install --upgrade pip sagemaker
pip install "requests==2.20.1"

# Install RISE for slideshow
source /home/ec2-user/anaconda3/bin/activate JupyterSystemEnv
/home/ec2-user/anaconda3/bin/conda install -y -c conda-forge rise
source /home/ec2-user/anaconda3/bin/deactivate

# Enable scrolling in RISE slideshows
python3 -c 'from traitlets.config.manager import BaseJSONConfigManager; from pathlib import Path; path = Path.home() / ".jupyter" / "nbconfig"; cm = BaseJSONConfigManager(config_dir=str(path)); cm.update( "rise", { "scroll": True})'

# Install system packages not provided by Amazon Linux by default
sudo yum install -y tree

# Configure docker data-dir to avoid running out of space
sudo service docker stop
sudo rm /etc/docker/daemon.json
sudo mv /var/lib/docker /home/ec2-user/SageMaker/docker-data  # /home/ec2-user/SageMaker has more disk space
sudo bash -c 'cat > /etc/docker/daemon.json <<EOL
{

    "runtimes": {
        "nvidia": {
            "path": "nvidia-container-runtime",
            "runtimeArgs": []
        }
    },
    "data-root": "/home/ec2-user/SageMaker/docker-data"
}
EOL'
sudo service docker start


EOF
